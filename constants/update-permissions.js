// This script fetches the latest permissions from the API,
// formats them into a TypeScript enum, and writes the result
// to the specified file path.

import fs from "fs";
import path from "path";

// --- CONFIGURATION ---
// The URL of the permissions API endpoint.
const API_URL = "https://noks.das-uty.uz/api/v1/auth/get-perms";
// The path where the 'permissions.ts' enum file should be saved.
// It's set to 'src/constants/permissions.ts' to match a common Nuxt/Vue project structure.
const OUTPUT_PATH = path.join(process.cwd(), "constants", "permissions.ts");

/**
 * Converts a permission key string (e.g., "profile:readAll")
 * into a valid TypeScript enum member name in UPPER_SNAKE_CASE
 * (e.g., "PROFILE_READ_ALL").
 * @param {string} key - The permission key from the API.
 * @returns {string} The formatted enum member name.
 */
function formatEnumKey(key) {
    return key
        .replace(/[-:.]/g, "_") // Step 1: Replace separators like '-' or ':' with an underscore.
        .replace(/([a-z0-9])([A-Z])/g, "$1_$2") // Step 2: Insert an underscore between a lowercase letter/number and an uppercase letter.
        .toUpperCase(); // Step 3: Convert the entire string to uppercase.
}

/**
 * Main function to fetch, process, and write the permissions enum.
 */
async function updatePermissionsEnum() {
    console.log(`üöÄ Starting permission update from ${API_URL}...`);

    try {
        // 1. Fetch data from the API
        const response = await fetch(API_URL);
        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }
        const jsonResponse = await response.json();

        // 2. Extract permission groups
        const permissionsData = jsonResponse?.data;
        if (!Array.isArray(permissionsData)) {
            throw new Error("Invalid data structure: 'data' is not an array.");
        }

        if (permissionsData.length === 0) {
            console.warn("‚ö†Ô∏è No permissions found in the API response.");
            return;
        }

        // 3. Generate the TypeScript enum content as a string
        let enumContent = `/**
 * @enum PermissionEnum
 * @description Defines the permissions for various actions within the system.
 * This file is auto-generated by a script. Do not edit manually.
 * Last updated: ${new Date().toISOString()}
 */
export enum PermissionEnum {\n`;

        const enumMembers = permissionsData
            .map((permission) => {
                const key = permission.name;
                const description = permission.description?.en || key;
                const comment = `  /** ${description} */`;
                const member = `  ${formatEnumKey(key)} = "${key}",`;
                return `${comment}\n${member}`;
            })
            .join("\n\n");

        enumContent += enumMembers;
        enumContent += "\n}\n";

        // 4. Write the content to the specified file
        // Ensure the directory exists before writing the file.
        const outputDir = path.dirname(OUTPUT_PATH);
        if (!fs.existsSync(outputDir)) {
            fs.mkdirSync(outputDir, { recursive: true });
        }

        fs.writeFileSync(OUTPUT_PATH, enumContent, "utf-8");

        console.log(`‚úÖ Successfully updated permissions enum at: ${OUTPUT_PATH}`);
        console.log(`   Processed ${permissionsData.length} permissions.`);
    } catch (error) {
        console.error("‚ùå Error updating permissions enum:", error.message);
        process.exit(1); // Exit with an error code
    }
}

// Run the script
updatePermissionsEnum();
